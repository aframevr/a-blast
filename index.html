<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>A-Shooter</title>
    <meta name="description" content="Room Scale A-Frame Demo">
    <link rel="stylesheet" href="css/main.css">
    <script src="vendor/aframe.js"></script>
    <script src="build/build.js"></script>
    <script src="waves.js"></script>
  </head>
  <body>
    <a-scene debug="true" gamestate="health: 5; wave: 1" decals="maxDecals: 30; src: #bulletDecal; size: 0.3">
      <a-assets>
        <img id="bulletDecal" src="https://feiss.github.io/a-shooter-assets/images/decal0.png" crossOrigin="anonymous">
        <img id="faceTemplate" src="https://feiss.github.io/a-shooter-assets/images/face_template.jpg" crossOrigin="anonymous">
        <audio id="backgroundMusic" src="https://fernandojsg.github.io/a-shooter-assets/sounds/music0.ogg" loop crossorigin="anonymous"></audio>
        <img id="fx1" src="https://feiss.github.io/a-shooter-assets/images/fx1.png" crossOrigin="anonymous">
        <img id="fx2" src="https://feiss.github.io/a-shooter-assets/images/fx2.png" crossOrigin="anonymous">
        <img id="fx3" src="https://feiss.github.io/a-shooter-assets/images/fx3.png" crossOrigin="anonymous">
        <img id="fx4" src="https://feiss.github.io/a-shooter-assets/images/fx4.png" crossOrigin="anonymous">
        <img id="fx5" src="https://feiss.github.io/a-shooter-assets/images/fx5.png" crossOrigin="anonymous">
        <img id="fx6" src="https://feiss.github.io/a-shooter-assets/images/fx6.png" crossOrigin="anonymous">
        <img id="fx7" src="https://feiss.github.io/a-shooter-assets/images/fx7.png" crossOrigin="anonymous">
        <audio id="backgroundMusicOgg" src="https://feiss.github.io/a-shooter-assets/sounds/music0.ogg"  crossorigin="anonymous"></audio>
        <audio id="explosion0" src="https://feiss.github.io/a-shooter-assets/sounds/explosion0.ogg"  crossorigin="anonymous"></audio>
        <audio id="explosion1" src="https://feiss.github.io/a-shooter-assets/sounds/explosion1.ogg"  crossorigin="anonymous"></audio>
        <audio id="explosion2" src="https://feiss.github.io/a-shooter-assets/sounds/explosion2.ogg"  crossorigin="anonymous"></audio>
      </a-assets>

      <a-entity id="backgroundMusic" sound="src: #backgroundMusicOgg; autoplay: false; loop: true"></a-entity>
      <a-entity id="explosion0" sound="src:#explosion0"></a-entity>
      <a-entity id="explosion1" sound="src:#explosion1"></a-entity>
      <a-entity id="explosion2" sound="src:#explosion2"></a-entity>

      <a-entity light="color: #ffffff; groundColor: #79a8bb; intensity: 0.3; type: hemisphere"></a-entity>
      <a-entity position="0 50 0" light="intensity: 0.9; type: point"></a-entity>
      <a-entity position="0 -50 0" light="intensity: 0.5; type: point"></a-entity>

      <a-entity id="player"
        camera="userHeight: 1.6"
        wasd-controls
        look-controls
        shoot="direction: 0 0 -1; spaceKeyEnabled: true">
        <!-- sound="src: url(https://fernandojsg.github.io/a-shooter-assets/sounds/hit0.ogg); on: player-hit" -->

        <a-entity id="gameover"
          gamestate-bind="isGameOver: visible"
          visible="false"
        ></a-entity>

        <a-entity id="hurt"
          geometry="primitive: sphere; radius: 1"
          material="shader: flat; side: back; color: #f00; transparent: true; opacity: 0.0"
          visible="false">
          <a-animation id="player-hit-anim" attribute="material.opacity" to="0.8" from="0" begin="player-hit" direction="alternate" dur="300" repeat="1"></a-animation>
        </a-entity>
      </a-entity>

      <!-- Hands. -->
      <a-entity id="leftHand" shoot-controls="hand: left" weapon shoot></a-entity>
      <a-entity id="rightHand" shoot-controls="hand: right" weapon shoot></a-entity>

      <a-entity id="border" json-model="src:url(https://feiss.github.io/a-shooter-assets/models/border.json); debugNormals: false" position="0 0 0"></a-entity>

      <a-entity id="gamestateDebug"
        gamestate-debug
        position="-5 1 -3"
        rotation="0 65 0"></a-entity>

      <a-entity id="waveText"
        position="0 2 -4"
        scale="3 3 3"
        wave-text>
        <a-animation attribute="bmfont-text.opacity" direction="alternate" dur="2500" from="0" begin="wavetextchange" to="1" repeat="1"></a-animation>
      </a-entity>

      <a-entity id="sky"
        geometry="primitive: sphere; radius: 200;"
        material="shader: flat; color: #1a4d5f; side: double; src: url(https://fernandojsg.github.io/a-shooter-assets/images/sky.jpg)"
      ></a-entity>

      <a-entity id="scoreboard"
        counter
        gamestate-bind="health: counter.health; points: counter.points"
        scale="0.05 0.05 0.05"
        rotation="0 40 0"
        obj-model="obj: url(https://fernandojsg.github.io/a-shooter-assets/models/counter.obj)"
        material="color: #fff"
      ></a-entity>
    </a-scene>

    <div id="a-shooter-footer">
      <a href="javascript:;" onclick="closeCamera()" id="closefooter">âœ–</a>
      <h1>Fancy a different enemy face?</h1>
      Drag and drop a picture to the browser<span id="cameracheck">, or <a href="javascript:;" onclick="openCamera()">take one with your camera</a></span>!
      <img src="https://feiss.github.io/a-shooter-assets/images/face_guide.png" id="cameraGuide">
      <div id="camera"></div>
      <a href="javascript:;" onclick="snap()" id="snap"></a>
    </div>
    
    <script type="text/javascript">


    var faceWidget = {
      canvas: null,
      ctx: null,
      video: null,
      stream: null,
      dom: null,
      texture: null
    };

    window.addEventListener('load', initFaceWidget);

    function initFaceWidget(event) {
      if (!(navigator.getUserMedia || navigator.webkitGetUserMedia ||
                  navigator.mozGetUserMedia || navigator.msGetUserMedia)){
        document.getElementById('cameracheck').style.display = 'none';
      }
      faceWidget.dom = document.getElementById('a-shooter-footer');
    }

    function openCamera(){
      var fw = faceWidget;
      if (fw.canvas !== null) return;
      fw.dom.style.bottom = '0';
      
      fw.canvas = document.createElement('canvas');
      fw.canvas.width = 80;
      fw.canvas.height = 80;
      fw.ctx = fw.canvas.getContext('2d');

      var templateImg = document.getElementById('faceTemplate');
      fw.texture = document.createElement('canvas');
      fw.texture.width = templateImg.width;
      fw.texture.height = templateImg.height;

      /* debug */
        fw.canvas.style.position = 'absolute';
        fw.canvas.style.top = '0';
        fw.canvas.style.left = '-200px';
        fw.dom.appendChild(fw.canvas);
        fw.texture.style.position = 'absolute';
        fw.texture.style.top = '-530px';
        fw.dom.appendChild(fw.texture);
      /* ------ */

      fw.video = document.createElement('video');
      fw.video.setAttribute('autoplay', 'autoplay');
      document.getElementById('camera').appendChild(fw.video);
      
      var constraints = { audio: false, video: { width: 320, height: 240 } }; 
      navigator.mediaDevices.getUserMedia(constraints)
      .then(function(mediaStream) {
        fw.video.srcObject = mediaStream;
        fw.stream = mediaStream;
      })
      .catch(function(err) { console.log(err.name + ": " + err.message); }); 
    }

    function closeCamera() {
      var fw = faceWidget;
      if (fw.stream) {
        var tracks = fw.stream.getTracks();
        for (var i in tracks) {
          tracks[i].stop();
        }
      }
      fw.dom.style.transition = "bottom 0.2s ease-out";
      fw.dom.style.bottom = '-450px';
      window.setTimeout(function (){
        fw.dom.parentNode.removeChild(fw.dom);
      }, 500);
    }

    function snap() {
      var fw = faceWidget;
      if (fw.stream) {
        var canvasW = fw.canvas.width;
        var canvasH = fw.canvas.height;
        var videoW = Math.floor(canvasW * 320 / 240);
        var px = Math.floor((canvasW - videoW) / 2);
        fw.ctx.drawImage(fw.video, px, 0, videoW, canvasH);

        var imageData = fw.ctx.getImageData(0, 0, canvasW, canvasH);
        var data = imageData.data;
        var radius = Math.pow(canvasW / 2 - 4, 2);
        var g;
        for (var i = 0; i < data.length; i += 4) {
          var dx = canvasW / 2 - (Math.floor(i / 4) % canvasW);
          var dy = canvasH / 2 - (Math.floor(i / 4 / canvasW));

          if (dx * dx + dy * dy > radius){
            g = 255;
          }
          else {
            g = (data[i] + data[i + 1] + data[i + 2]) / 3;
            g = Math.floor(g / 32) * 32;
          }

          data[i]     = g;
          data[i + 1] = g;
          data[i + 2] = g;
        }

        fw.ctx.putImageData(imageData, 0, 0);
        
        var templateImg = document.getElementById('faceTemplate');
        var c = fw.texture.getContext('2d');
        c.imageSmoothingEnabled = false;
        c.globalCompositeOperation = "normal";
        c.drawImage(templateImg, 0, 0);
        c.globalCompositeOperation = "multiply";
        c.drawImage(fw.canvas, 0, 0, fw.texture.width, fw.texture.height);

        // texture is available in faceWidget.texture

        fw.texture.style.display= 'block';
      }
    }

    </script>
  </body>
</html>
